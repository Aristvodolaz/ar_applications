# AR Application

## Описание проекта

AR Application - это инновационное приложение для Android, разработанное для обеспечения видеосвязи и удаленной поддержки с использованием технологий дополненной реальности (AR). Приложение оптимизировано как для стандартных мобильных устройств, так и для AR-очков, предоставляя адаптивный пользовательский интерфейс, который автоматически настраивается в зависимости от типа устройства.

## Основные функции

- **Аутентификация с помощью QR-кода**: Быстрый и безопасный вход в систему путем сканирования QR-кода.
- **Видеозвонки с поддержкой AR**: Высококачественные видеозвонки с возможностью добавления аннотаций в режиме реального времени.
- **Адаптивный интерфейс**: Автоматическая адаптация UI для обычных устройств и AR-очков.
- **Управление жестами**: Интуитивное управление для AR-устройств с помощью жестов.
- **Обмен файлами**: Возможность обмена файлами во время видеозвонка.
- **Чат**: Текстовый чат для обмена сообщениями во время видеозвонка.
- **Аннотации**: Возможность добавления визуальных пометок на видеопоток для улучшения коммуникации.
- **Выбор камеры**: Возможность выбора между фронтальной, основной и внешними камерами устройства.
- **Встроенный WebView**: оптимизированный для AR-устройств интерфейс для просмотра веб-страниц.
- **Nextcloud Talk**: возможность осуществления видеозвонков через Nextcloud Talk, с адаптивным интерфейсом для AR-устройств.

## Архитектура проекта

Проект следует модульной архитектуре, состоящей из:

- **app**: основной модуль приложения, содержащий MainActivity и навигацию.
- **core**: модуль с общими компонентами, утилитами и ресурсами.
- **auth**: модуль для авторизации пользователей через QR-код.
- **videocall**: Модуль видеозвонков с поддержкой WebRTC и аннотаций.

## Технологии

- **Kotlin**: Основной язык программирования.
- **Jetpack Compose**: Современный инструментарий для создания нативного UI на Android.
- **Hilt**: Внедрение зависимостей.
- **Coroutines & Flow**: Асинхронное программирование.
- **WebRTC**: Технология для видеозвонков в реальном времени.
- **CameraX**: API для работы с камерой.
- **Accompanist**: Библиотека для расширения возможностей Compose.

## Требования

- Android 7.0 (API 24) или выше
- Поддержка AR-устройств (опционально)
- Доступ к камере и микрофону

## Установка и запуск

1. Клонируйте репозиторий:
   ```
   git clone https://github.com/your-username/ar_application.git
   ```

2. Откройте проект в Android Studio.

3. Синхронизируйте Gradle и дождитесь завершения загрузки зависимостей.

4. Запустите приложение на устройстве или эмуляторе.

## Особенности разработки

### Адаптивный UI

Приложение использует специальный класс `ARConfig` для настройки UI в зависимости от типа устройства. Для AR-устройств применяются увеличенные размеры элементов, высококонтрастные цвета и оптимизированные шрифты для лучшей видимости.

```kotlin
data class ARConfig(
    val isARDevice: Boolean = false,
    val largePadding: Dp = if (isARDevice) 32.dp else 16.dp,
    val mediumPadding: Dp = if (isARDevice) 16.dp else 8.dp,
    // ...
)
```

### Тестовый режим

В текущей версии приложения реализован тестовый режим, при котором сразу после запуска автоматически открывается WebView с предустановленной ссылкой `https://ar.sitebill.site/fpin/29`. Это позволяет быстро протестировать работу WebView на различных устройствах.

```kotlin
// Настройка стартового маршрута на WebView с тестовой ссылкой
@Composable
fun AppNavigation(
    navController: NavHostController = rememberNavController(),
    startDestination: String = Screen.WebView.createRoute("https://ar.sitebill.site/fpin/29")
) {
    // ...
}
```

При нажатии на кнопку "Домой" в верхней панели WebView пользователь переходит на главный экран приложения, где может ввести другой URL для открытия.

### Звонки через Nextcloud

В приложении реализована возможность осуществления видеозвонков через Nextcloud Talk. Это позволяет пользователям AR-устройства участвовать в видеоконференциях и делиться своим видением.

#### Особенности реализации:

1. **Оптимизированный интерфейс для AR-устройств**:
   - Увеличенные кнопки управления для удобства взаимодействия
   - Высококонтрастная цветовая схема для лучшей видимости
   - Адаптивные размеры элементов и шрифтов

2. **Поддержка WebRTC**:
   - Автоматическое предоставление разрешений на доступ к камере и микрофону
   - Оптимизированные настройки WebView для работы с WebRTC
   - Автоматическое присоединение к звонку

3. **Аутентификация с токеном**:
   - Поддержка аутентификации через токен приложения Nextcloud
   - Безопасное хранение токена на устройстве
   - Автоматическое добавление токена к заголовкам запросов
   - Поддержка передачи токена как в URL, так и через авторизационный заголовок

```kotlin
// Пример перехвата запросов для добавления токена авторизации
override fun shouldInterceptRequest(
    view: WebView?,
    request: WebResourceRequest?
): WebResourceResponse? {
    if (token != null && request != null) {
        val url = request.url.toString()
        
        // Если это запрос к Nextcloud
        if (url.contains("nextcloud") || isNextcloudCall) {
            try {
                val connection = java.net.URL(url).openConnection()
                
                // Добавляем заголовок авторизации
                connection.setRequestProperty("Authorization", "Bearer $token")
                
                // Получаем ответ
                val inputStream = connection.getInputStream()
                val contentType = connection.contentType ?: "text/html"
                val encoding = connection.contentEncoding ?: "utf-8"
                
                return WebResourceResponse(
                    contentType,
                    encoding,
                    inputStream
                )
            } catch (e: Exception) {
                // В случае ошибки продолжаем стандартную загрузку
                return super.shouldInterceptRequest(view, request)
            }
        }
    }
    
    return super.shouldInterceptRequest(view, request)
}
```

4. **Интеграция с существующими экранами**:
   - Доступ к звонкам Nextcloud через главный экран приложения
   - Список контактов с возможностью поиска
   - Настройка подключения к серверу Nextcloud
   - Плавная навигация между экранами звонков и основным интерфейсом

### Управление жестами

Для AR-устройств реализовано специальное управление жестами:
- Свайп влево: включение/выключение микрофона
- Свайп вправо: включение/выключение камеры
- Двойное нажатие: завершение звонка

### Запрос разрешений

Приложение включает красивые экраны запроса разрешений с анимацией и информативным описанием, что улучшает пользовательский опыт:

```kotlin
@Composable
fun CameraPermissionScreen(
    onRequestPermission: () -> Unit,
    config: ARConfig? = null
) {
    PermissionScreen(
        title = "Доступ к камере",
        description = "Для работы приложения необходим доступ к камере...",
        // ...
    )
}
```

### Выбор камеры

Приложение автоматически определяет доступные камеры на устройстве и предоставляет удобный интерфейс для их выбора:

```kotlin
// Получение списка доступных камер
val availableCameras = CameraUtils.getAvailableCameras(context)

// Диалог выбора камеры
CameraSelectorDialog(
    availableCameras = availableCameras,
    selectedCamera = selectedCamera,
    onCameraSelected = { camera ->
        // Переключение на выбранную камеру
    },
    onDismiss = { /* ... */ },
    config = config
)
```

Поддерживаются следующие типы камер:
- Фронтальная камера (для селфи)
- Основная камера (задняя)
- Внешние камеры (если подключены к устройству)

## Лицензия

© 2023 AI Technologi. Все права защищены.

## Контакты

Для вопросов и предложений по проекту обращайтесь:
- Email: support@ai-technologi.com
- Сайт: https://ai-technologi.com

---

*Примечание: Это приложение оптимизировано для работы с AR-очками Rokid, но также поддерживает стандартные Android-устройства.* 